# This file is autogenerated generated from nginx.conf.template
# All chnages should happend in the template and then generate this file via wpcmd -r [-n=<siteName>]
# All environment variables are defined in env.template
version: '3.7'

# Services
services:

  # MySQL Service
  mysql:
    container_name:                demo-mysql
    image:                         mysql:8.0.22
    restart:                       always
    working_dir:                   /var/lib/mysql
    environment:
      MYSQL_PORT:                  3306
      MYSQL_DATABASE:              demo
      MYSQL_USER:                  demo
      MYSQL_PASSWORD_FILE:         /run/secrets/db-pwd-demo
      MYSQL_ALLOW_EMPTY_PASSWORD:  "yes"
    volumes:
      - ./.docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro # to check
      - mysql-volume:/var/lib/mysql
    secrets:
      - db-pwd-demo

  # Wordpress Service
  wordpress:
    container_name:                  demo-wordpress
    image:                           wordpress:5.6.0-php7.4-fpm-alpine
    restart:                         always
    working_dir:                     /var/www/html
    environment:
      WORDPRESS_DB_HOST:             mysql
      WORDPRESS_DB_NAME:             demo
      WORDPRESS_DB_USER:             demo
      WORDPRESS_DB_PASSWORD_FILE:    /run/secrets/db-pwd-demo
      WORDPRESS_TABLE_PREFIX:        wp_
    volumes:
      - wordpress-volume:/var/www/html
    depends_on:
      - mysql
    links:
      - mysql
    secrets:
      - db-pwd-demo

  # PhpMyAdmin Service
  phpmyadmin:
    container_name:                  demo-phpmyadmin
    image:                           phpmyadmin/phpmyadmin:5.0.0-fpm-alpine 
    restart:                         "no"
    working_dir:                     /var/www/phpmyadmin
    environment:
      PMA_HOST:                      mysql
    volumes:
      - phpmyadmin-volume:/var/www/phpmyadmin
    depends_on:
      - mysql

  # Nginx Service
  nginx:
    container_name:                  demo-nginx
    image:                           thetek/nginx:1.17-alpine
    restart:                         always
    working_dir:                     /etc/nginx
    environment:
      WORDPRESS_ALL_SERVER_URLS:     example.com
      PHPMYADMIN_ALL_SERVER_URLS:    phpmyadmin.example.com
      LETSENCRYPT_ADMIN_EMAIL_FILE:  /run/secrets/admin-email-demo
    volumes:
      - nginx-certboot-volume:/etc/letsencrypt
      - wordpress-volume:/var/www/html:ro,delegated
      - phpmyadmin-volume:/var/www/phpmyadmin:ro,delegated
    depends_on:
      - wordpress
      - phpmyadmin
    secrets:
      - admin-email-demo
    ports:
      - 8080:80
      - www.example.com:443

  # Backup service
  wpbackup:
    container_name:                  demo-wpbackup
    image:                           thetek/wpbackup:1.0.0
    restart:                         always
    working_dir:                     /var/backups/demo
    environment:
      WPBACKUP_WEBSITE_NAME:         demo
      WPBACKUP_MYSQL_HOST:           mysql
      WPBACKUP_MYSQL_PORT:           3306
      WPBACKUP_MYSQL_DATABASE:       demo
      WPBACKUP_MYSQL_USERNAME:       demo
      WPBACKUP_MYSQL_PASSWORD_FILE:  /run/secrets/db-pwd-demo
      WPBACKUP_WORDPRESS_DIR:        /var/www/html
      WPBACKUP_ROOT_DIR:             /var/backups/demo
      WPBACKUP_HOUR:                 0
    volumes:
      - wordpress-volume:/var/www/html:ro,delegated
      - wpbackup-volume:/var/backups/demo:cached
    depends_on:
      - mysql
    secrets:
      - db-pwd-demo
  
  # Webdrive service
  webdrive:
    container_name: demo-webdrive
    image: thetek/webdrive:1.0.0
    restart: always
    working_dir:                     /mnt/webdrive/demo
    environment:
      WEBDRIVE_REMOTE_PATH:          demo
      WEBDRIVE_CER_FILE:             /run/secrets/webdav-cer-demo
      WEBDRIVE_URL_FILE:             /run/secrets/webdav-url-demo
      WEBDRIVE_UID_FILE:             /run/secrets/webdav-uid-demo
      WEBDRIVE_PWD_FILE:             /run/secrets/webdav-pwd-demo
    volumes:
      - wpbackup-volume:/var/backups/demo:cached
      - webdrive-volume:/mnt/webdrive/demo:delegated
    secrets:
      - webdav-cer-demo
      - webdav-url-demo
      - webdav-uid-demo
      - webdav-pwd-demo
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN
    privileged: true

# Secrets
secrets:
  db-pwd-demo:
    file: ./.docker/mysql/secret/mysqldb-pwd.txt
  admin-email-demo:
    file: ./.docker/nginx/secret/admin-email.txt
  webdav-cer-demo:
    file: ./.docker/webdrive/secret/webdrive-cer-demo.cer
  webdav-url-demo:
    file: ./.docker/webdrive/secret/webdrive-url-demo.txt
  webdav-uid-demo:
    file: ./.docker/webdrive/secret/webdrive-uid-demo.txt
  webdav-pwd-demo:
    file: ./.docker/webdrive/secret/webdrive-pwd-demo.txt

# Volumes
volumes:
  mysql-volume: {}
  wordpress-volume: {}
  phpmyadmin-volume: {}
  nginx-certboot-volume: {}
  wpbackup-volume: {}
  webdrive-volume: {}
