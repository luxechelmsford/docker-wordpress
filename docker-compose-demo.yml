# This file is autogenerated generated from docker-compose.template
# All chnages should happend in the template file
#  THis file then can be generate by:
# 1. First adding a wevsite config data in site.txt
#        wpcmd -c=site -a -n=<sitename> -p=<ext http port - nginx> -x=<ext https port - nginx> -w<example.com> [-u<www.example.com>]
# 2. then generting yml file for the website:
#        wpcmd -r [-n=<siteName>]
# Note: All environment variables used here are are defined in env.template

version: '3.8'

# Services
services:

  # MySQL Service
  mysql:
    container_name:                   ${WEBSITE_NAME}-mysql
    image:                            ${MYSQL_IMAGE}
    restart:                          always
    working_dir:                      /var/lib/mysql
    environment:
      MYSQL_PORT:                     ${MYSQL_PORT}
      MYSQL_HOST:                     ${MYSQL_HOST}
      MYSQL_DATABASE:                 ${MYSQL_DATABASE}
      MYSQL_USER:                     ${MYSQL_USER}
      MYSQL_ROOT_PASSWORD:            ${MYSQL_ROOT_PASSWORD}
      MYSQL_PASSWORD:                 ${MYSQL_PASSWORD}
    volumes:
      - mysql-data-volume:/var/lib/mysql
      - mysql-conf-volume:/etc/mysql/conf.d
      - log-data-volume:/var/log
    cap_add:
      - SYS_NICE                      # CAP_SYS_NICE

  # Wordpress Service
  wordpress:
    container_name:                   ${WEBSITE_NAME}-wordpress
    image:                            ${WORDPRESS_IMAGE}
    restart:                          always
    working_dir:                      ${WORDPRESS_ROOT_DIR}
    environment:
      # Do not add host here, it causes the error - mysqli::__construct(): (HY000/2002)
      # 2022-03-30 Now it seems to be fine with the host name in
      WORDPRESS_DB_HOST:             ${MYSQL_HOST}
      WORDPRESS_DB_NAME:              ${MYSQL_DATABASE}
      WORDPRESS_DB_USER:              ${MYSQL_USER}
      WORDPRESS_DB_PASSWORD:          ${MYSQL_PASSWORD}
      WORDPRESS_TABLE_PREFIX:         ${WORDPRESS_TABLE_PREFIX}
      WORDPRESS_CONFIG_EXTRA: |
        define( 'WP_HOME', '${WORDPRESS_HOME}' );
        define( 'WP_SITEURL', '${WORDPRESS_SITEURL}' );
        define( 'FS_METHOD', 'direct');
    volumes:
      - wordpress-data-volume:${WORDPRESS_ROOT_DIR}
      - log-data-volume:/var/log
    depends_on:
      - mysql
    links:
      - mysql

  # PhpMyAdmin Service
  phpmyadmin:
    container_name:                   ${WEBSITE_NAME}-phpmyadmin
    image:                            phpmyadmin/phpmyadmin:5.0.0-fpm-alpine 
    restart:                          always
    working_dir:                      ${PHPMYADMIN_ROOT_DIR}
    environment:
      PHPMYADMIN_ENABLED:            "${PHPMYADMIN_ENABLED}"
      PMA_HOST:                       mysql
    volumes:
      - phpmyadmin-data-volume:${PHPMYADMIN_ROOT_DIR}
      - log-data-volume:/var/log
    depends_on:
      - mysql

  # Nginx Service
  nginx:
    container_name:                  ${WEBSITE_NAME}-nginx
    image:                           thetek/nginx:1.17-alpine
    restart:                         always
    working_dir:                     /etc/nginx
    environment:
      LETSENCRYPT_ADMIN_EMAIL:       ${ADMIN_EMAIL}
      LETSENCRYPT_MODE:              ${LETSENCRYPT_MODE}
      LETSENCRYPT_LOG_DIR:           /var/log/letsencrypt
      NGINX_LOG_DIR:                 /var/log/nginx
      WORDPRESS_ALL_SERVER_URLS:     "${WORDPRESS_ALL_SERVER_URLS}"
      PHPMYADMIN_ALL_SERVER_URLS:    "${PHPMYADMIN_ALL_SERVER_URLS}"
      PHPMYADMIN_ENABLED:            "${PHPMYADMIN_ENABLED}"
    volumes:
      - log-data-volume:/var/log
      - nginx-cert-volume:/etc/letsencrypt
      - wordpress-data-volume:${WORDPRESS_ROOT_DIR}
      - phpmyadmin-data-volume:${PHPMYADMIN_ROOT_DIR}
    depends_on:
      - wordpress
      - phpmyadmin
#    ports:
#      - ${WEB_HTTP_PORT}:80
#      - ${WEB_HTTPS_PORT}:443
    networks:
      - default
      - proxynet


  # Backup service
  wpbackup:
    container_name:                  ${WEBSITE_NAME}-wpbackup
    image:                           thetek/wpbackup:1.0.0
    restart:                         always
    working_dir:                     ${WPBACKUP_ROOT_DIR}
    environment:
      WPBACKUP_ENABLED:              "${WPBACKUP_ENABLED}"
      WPBACKUP_WEBSITE:              ${WEBSITE_NAME}
      WPBACKUP_DB_HOST:              ${MYSQL_HOST}
      WPBACKUP_DB_NAME:              ${MYSQL_DATABASE}
      WPBACKUP_DB_USER:              ${MYSQL_USER}
      WPBACKUP_DB_PASSWORD:          ${MYSQL_PASSWORD}
      WPBACKUP_ROOT_DB_PASSWORD:     ${MYSQL_ROOT_PASSWORD}
      WPBACKUP_WPCONTENT_DIR:        ${WORDPRESS_ROOT_DIR}/wp-content
      WPBACKUP_ROOT_DIR:             ${WPBACKUP_ROOT_DIR}
      WPBACKUP_LOG_DIR:              /var/log/wpbackup
      WPBACKUP_RESTORE_KEY:          restore-me.txt
      WPBACKUP_WPCUSTOM_KEY:         wpcustom.txt
      WPBACKUP_DROPBOX_TOKEN:        ${DROPBOX_TOKEN}
      WPBACKUP_GPG_PASSWORD:         ${GPG_PASSWORD}
      MYSQL_USER_CNF_FILE:           /etc/mysql/conf.d/my.cnf
      MYSQL_ROOT_CNF_FILE:           /etc/mysql/root.cnf
      WP_CLEAN_DAILY_DAYS:           ${WP_CLEAN_DAILY_DAYS}
      WP_CLEAN_WEEKLY_DAYS:          ${WP_CLEAN_WEEKLY_DAYS}
      WP_CLEAN_MONTHLY_DAYS:         ${WP_CLEAN_MONTHLY_DAYS}
    volumes:
      - log-data-volume:/var/log
      - wordpress-data-volume:${WORDPRESS_ROOT_DIR}
      - wpbackup-data-volume:${WPBACKUP_ROOT_DIR}
    depends_on:
      - mysql
  
  # Webdrive service
  webdrive:
    container_name:                  ${WEBSITE_NAME}-webdrive
    image:                           thetek/webdrive:1.0.0
    restart:                         always
    working_dir:                     ${WPBACKUP_ROOT_DIR}
    environment:
      WEBDRIVE_ENABLED:              "${WEBDRIVE_ENABLED}"
      WEBDRIVE_URL:                  ${WEBDRIVE_URL}
      WEBDRIVE_UID:                  ${WEBDRIVE_UID}
      WEBDRIVE_PWD:                  ${WEBDRIVE_PWD}
      WEBDRIVE_ROOT_DIR:             ${WEBDRIVE_ROOT_DIR}
      WPBACKUP_ROOT_DIR:             ${WPBACKUP_ROOT_DIR}
    volumes:
      - log-data-volume:/var/log
      - wpbackup-data-volume:${WPBACKUP_ROOT_DIR}:cached
      - webdrive-data-volume:${WEBDRIVE_ROOT_DIR}:delegated
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN
    privileged: true
  
#  # Vsftpd service
#  vsftpd:
#    container_name:                  ${WEBSITE_NAME}-vsftpd
#    image:                           thetek/vsftpd:1.0.0
#    restart:                         "no"
#    working_dir:                     ${WORDPRESS_ROOT_DIR}
#    environment:
#      VSFTPD_ENABLED:                "${VSFTPD_ENABLED}"
#      VSFTPD_USERNAME:               ${VSFTPD_USERNAME}
#      VSFTPD_PASSWORD:               ${VSFTPD_PASSWORD}
#      VSFTPD_HOME_DIR:               ${WORDPRESS_ROOT_DIR}/wp-content
#      VSFTPD_SERVER_URL:             ${VSFTPD_SERVER_URL}
#    volumes:
#      - log-data-volume:/var/log
#      - wordpress-data-volume:${WORDPRESS_ROOT_DIR}
#    ports:
#      - 0.0.0.0:${VSFTPD_CMD_PORT}:21
#      - 0.0.0.0:${VSFTPD_PSV_PORTS}:21000-21010

# Volumes
volumes:
  log-data-volume:                   {}
  mysql-data-volume:                 {}
  mysql-conf-volume:                 {}
  wordpress-data-volume:             {}
  phpmyadmin-data-volume:            {}
  nginx-cert-volume:                 {}
  wpbackup-data-volume:              {}
  webdrive-data-volume:              {}

# Network
networks:
  proxynet:
    name: dockernet
