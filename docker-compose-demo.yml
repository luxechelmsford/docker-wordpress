# This file is autogenerated generated from docker-compose.template
# All chnages should happend in the template file
#  THis file then can be generate by:
# 1. First adding a wevsite config data in site.txt
#        wpcmd -c=site -a -n=<sitename> -p=<ext http port - nginx> -x=<ext https port - nginx> -w<example.com> [-u<www.example.com>]
# 2. then generting yml file for the website:
#        wpcmd -r [-n=<siteName>]
# Note: All environment variables used here are are defined in env.template

version: '3.8'

# Services
services:

  # MySQL Service
  mysql:
    container_name:                   demo-mysql
    image:                            thetek/mysql:8.0.22
    restart:                          always
    working_dir:                      /var/lib/mysql
    environment:
      MYSQL_PORT:                     3306
      MYSQL_HOST:                     mysql
      MYSQL_DATABASE:                 demo
      MYSQL_USER:                     demo
      MYSQL_ROOT_PASSWORD:            mysqlrootpassword
      MYSQL_PASSWORD:                 mysqluserpassword
    volumes:
      - mysql-data-volume:/var/lib/mysql
      - mysql-conf-volume:/etc/mysql/conf.d
      - log-data-volume:/var/log
    cap_add:
      - SYS_NICE                      # CAP_SYS_NICE

  # Wordpress Service
  wordpress:
    container_name:                   demo-wordpress
    image:                            wordpress:5.6.0-php7.4-fpm-alpine
    restart:                          always
    working_dir:                      /var/www/html
    environment:
      # Do not add host here, it causes the error - mysqli::__construct(): (HY000/2002)
      #WORDPRESS_DB_HOST:             mysql
      WORDPRESS_DB_NAME:              demo
      WORDPRESS_DB_USER:              demo
      WORDPRESS_DB_PASSWORD:          mysqluserpassword
      WORDPRESS_TABLE_PREFIX:         wp_
      WORDPRESS_CONFIG_EXTRA: |
        define( 'WP_HOME', 'http://www.example.com' );
        define( 'WP_SITEURL', 'http://www.example.com' );
        define( 'FS_METHOD', 'direct');
    volumes:
      - wordpress-data-volume:/var/www/html
      - log-data-volume:/var/log
    depends_on:
      - mysql
    links:
      - mysql

  # PhpMyAdmin Service
  phpmyadmin:
    container_name:                   demo-phpmyadmin
    image:                            phpmyadmin/phpmyadmin:5.0.0-fpm-alpine 
    restart:                          "no"
    working_dir:                      /var/www/phpmyadmin
    environment:
      PHPMYADMIN_ENABLED:            "yes"
      PMA_HOST:                       mysql
    volumes:
      - phpmyadmin-data-volume:/var/www/phpmyadmin
      - log-data-volume:/var/log
    depends_on:
      - mysql

  # Nginx Service
  nginx:
    container_name:                  demo-nginx
    image:                           thetek/nginx:1.17-alpine
    restart:                         always
    working_dir:                     /etc/nginx
    environment:
      LETSENCRYPT_ADMIN_EMAIL:       admin@example.com
      LETSENCRYPT_MODE:              disabled
      LETSENCRYPT_LOG_DIR:           /var/log/letsencrypt
      NGINX_LOG_DIR:                 /var/log/nginx
      WORDPRESS_ALL_SERVER_URLS:     "www.example.com example.com"
      PHPMYADMIN_ALL_SERVER_URLS:    "sql.example.com"
      PHPMYADMIN_ENABLED:            "yes"
    volumes:
      - log-data-volume:/var/log
      - nginx-cert-volume:/etc/letsencrypt
      - wordpress-data-volume:/var/www/html
      - phpmyadmin-data-volume:/var/www/phpmyadmin
    depends_on:
      - wordpress
      - phpmyadmin
#    ports:
#      - 20100:80
#      - 30100:443
    networks:
      - default
      - proxynet


  # Backup service
  wpbackup:
    container_name:                  demo-wpbackup
    image:                           thetek/wpbackup:1.0.0
    restart:                         always
    working_dir:                     /var/backups/demo
    environment:
      WPBACKUP_ENABLED:              "yes"
      WPBACKUP_WEBSITE:              demo
      WPBACKUP_DB_HOST:              mysql
      WPBACKUP_DB_NAME:              demo
      WPBACKUP_DB_USER:              demo
      WPBACKUP_DB_PASSWORD:          mysqluserpassword
      WPBACKUP_ROOT_DB_PASSWORD:     mysqlrootpassword
      WPBACKUP_WPCONTENT_DIR:        /var/www/html/wp-content
      WPBACKUP_ROOT_DIR:             /var/backups/demo
      WPBACKUP_LOG_DIR:              /var/log/wpbackup
      WPBACKUP_RESTORE_KEY:          restore-me.txt
      WPBACKUP_WPCUSTOM_KEY:         wpcustom.txt
      WPBACKUP_DROPBOX_TOKEN:        
      WPBACKUP_GPG_PASSWORD:         
      MYSQL_USER_CNF_FILE:           /etc/mysql/conf.d/my.cnf
      MYSQL_ROOT_CNF_FILE:           /etc/mysql/root.cnf
      WP_CLEAN_DAILY_DAYS:           30
      WP_CLEAN_WEEKLY_DAYS:          180
      WP_CLEAN_MONTHLY_DAYS:         365
    volumes:
      - log-data-volume:/var/log
      - wordpress-data-volume:/var/www/html
      - wpbackup-data-volume:/var/backups/demo
    depends_on:
      - mysql
  
  # Webdrive service
  webdrive:
    container_name:                  demo-webdrive
    image:                           thetek/webdrive:1.0.0
    restart:                         always
    working_dir:                     /var/backups/demo
    environment:
      WEBDRIVE_ENABLED:              "no"
      WEBDRIVE_URL:                  
      WEBDRIVE_UID:                  
      WEBDRIVE_PWD:                  
      WEBDRIVE_ROOT_DIR:             /mnt/webdrive/demo
      WPBACKUP_ROOT_DIR:             /var/backups/demo
    volumes:
      - log-data-volume:/var/log
      - wpbackup-data-volume:/var/backups/demo:cached
      - webdrive-data-volume:/mnt/webdrive/demo:delegated
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN
    privileged: true
  
#  # Vsftpd service
#  vsftpd:
#    container_name:                  demo-vsftpd
#    image:                           thetek/vsftpd:1.0.0
#    restart:                         "no"
#    working_dir:                     /var/www/html
#    environment:
#      VSFTPD_ENABLED:                "no"
#      VSFTPD_USERNAME:               demo
#      VSFTPD_PASSWORD:               ghtyVX45BDYF7TD45FWL
#      VSFTPD_HOME_DIR:               /var/www/html/wp-content
#      VSFTPD_SERVER_URL:             ftp.example.com
#    volumes:
#      - log-data-volume:/var/log
#      - wordpress-data-volume:/var/www/html
#    ports:
#      - 0.0.0.0:40100:21
#      - 0.0.0.0:51100-51110:21000-21010

# Volumes
volumes:
  log-data-volume:                   {}
  mysql-data-volume:                 {}
  mysql-conf-volume:                 {}
  wordpress-data-volume:             {}
  phpmyadmin-data-volume:            {}
  nginx-cert-volume:                 {}
  wpbackup-data-volume:              {}
  webdrive-data-volume:              {}

# Network
networks:
  proxynet:
    external:
      name: dockernet
