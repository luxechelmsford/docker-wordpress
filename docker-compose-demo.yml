# This file is autogenerated generated from docker-compose.template
# All chnages should happend in the template file
#  THis file then can be generate by:
# 1. First adding a wevsite config data in site.txt
#        wpcmd -c=site -a -n=<sitename> -p=<ext http port - nginx> -x=<ext https port - nginx> -w<example.com> [-u<www.example.com>]
# 2. then generting yml file for the website:
#        wpcmd -r [-n=<siteName>]
# Note: All environment variables used here are are defined in env.template

version: '3.8'

# Services
services:

  # MySQL Service
  mysql:
    container_name:                  demo-mysql
    image:                           thetek/mysql:8.0.22
    restart:                         always
    working_dir:                     /var/lib/mysql
    environment:
      MYSQL_PORT:                    3306
      MYSQL_HOST:                    mysql
      MYSQL_DATABASE:                demo
      MYSQL_USER:                    demo
      MYSQL_ROOT_PASSWORD:           szgjzFFG556FF14255
      MYSQL_PASSWORD:                fdgshadfg53476cvgda
      #MYSQL_ALLOW_EMPTY_PASSWORD:   "yes"
    volumes:
      - mysql-data-volume:/var/lib/mysql
      - wpbackup-data-volume:/var/backups/demo
#    secrets:
#      - source:                      mysql-pwd-key
#        target:                      /run/secrets/
#   #configs:
#      - source:                      mysql-cnf-key
#        target:                      /etc/mysql/conf.d/my.cnf
    cap_add:
      - SYS_NICE                     # CAP_SYS_NICE

  # Wordpress Service
  wordpress:
    container_name:                  demo-wordpress
    image:                           wordpress:5.6.0-php7.4-fpm-alpine
    restart:                         always
    working_dir:                     /var/www/html
    environment:
      WORDPRESS_DB_HOST:             mysql
      WORDPRESS_DB_NAME:             demo
      WORDPRESS_DB_USER:             demo
      WORDPRESS_DB_PASSWORD:         fdgshadfg53476cvgda
      WORDPRESS_TABLE_PREFIX:        wp_
      WORDPRESS_CONFIG_EXTRA: |
        define( 'WP_HOME', 'http://www.example.com' );
        define( 'WP_SITEURL', 'http://www.example.com' );
    volumes:
      - wordpress-data-volume:/var/www/html
    depends_on:
      - mysql
    links:
      - mysql
#    secrets:
#      - source:                      mysql-pwd-key
#        target:                      /run/secrets/

  # PhpMyAdmin Service
  phpmyadmin:
    container_name:                  demo-phpmyadmin
    image:                           phpmyadmin/phpmyadmin:5.0.0-fpm-alpine 
    restart:                         "no"
    working_dir:                     /var/www/phpmyadmin
    environment:
      PMA_HOST:                      mysql
    volumes:
      - phpmyadmin-data-volume:/var/www/phpmyadmin
    depends_on:
      - mysql

  # Nginx Service
  nginx:
    container_name:                  demo-nginx
    image:                           thetek/nginx:1.17-alpine
    restart:                         always
    working_dir:                     /etc/nginx
    environment:
      LETSENCRYPT_ADMIN_EMAIL:       admin@example.com
      LETSENCRYPT_MODE:              disabled
      LETSENCRYPT_LOG_DIR:           /var/log/letsencrypt
      NGINX_LOG_DIR:                 /var/log/nginx
      WORDPRESS_ALL_SERVER_URLS:     "www.example.com example.com"
      PHPMYADMIN_ALL_SERVER_URLS:    "sql.example.com"
    volumes:
      - log-data-volume:/var/log
      - nginx-cert-volume:/etc/letsencrypt
      - wordpress-data-volume:/var/www/html
      - phpmyadmin-data-volume:/var/www/phpmyadmin
#    secrets:
#   #configs:
#      - source:                      nginx-wordpress-cnf-key
#        target:                      /run/secrets/
#      - source:                      nginx-phpmyadmin-cnf-key
#        target:                      /run/secrets/
    depends_on:
      - wordpress
      - phpmyadmin
    ports:
      - 8080:80
      - 8443:443

  # Backup service
  wpbackup:
    container_name:                  demo-wpbackup
    image:                           thetek/wpbackup:1.0.0
    restart:                         always
    working_dir:                     /var/backups/demo
    environment:
      WPBACKUP_ENABLED:              "yes"
      WPBACKUP_WEBSITE:              demo
      WPBACKUP_DB_HOST:              mysql
      WPBACKUP_DB_NAME:              demo
      WPBACKUP_DB_USER:              demo
      WPBACKUP_DB_PASSWORD:          fdgshadfg53476cvgda
      WPBACKUP_ROOT_DB_PASSWORD:     szgjzFFG556FF14255
      WPBACKUP_WPCONTENT_DIR:        /var/www/html/wp-content
      WPBACKUP_ROOT_DIR:             /var/backups/demo
      WPBACKUP_LOG_DIR:              /var/log/wpbackup
      WPBACKUP_RESTORE_KEY:          restore-me.txt
      WPBACKUP_WPCUSTOM_KEY:         wpcustom.txt
      WPBACKUP_DROPBOX_TOKEN:        
      WPBACKUP_GPG_PASSWORD:         
      MYSQL_USER_CNF_FILE:           /etc/mysql/conf.d/my.cnf
      MYSQL_ROOT_CNF_FILE:           /etc/mysql/root.cnf
      WP_CLEAN_DAILY_DAYS:           30
      WP_CLEAN_WEEKLY_DAYS:          180
      WP_CLEAN_MONTHLY_DAYS:         365
    volumes:
      - log-data-volume:/var/log
      - wordpress-data-volume:/var/www/html
      - wpbackup-data-volume:/var/backups/demo
    depends_on:
      - mysql
#    secrets:
#      - source:                      mysql-pwd-key
#        target:                      /run/secrets/
#      - source:                      dropbox-token-key
#        target:                      /run/secrets/
#      - source:                      gpg-password-key
#        target:                      /run/secrets/
  
  # Webdrive service
  webdrive:
    container_name:                  demo-webdrive
    image:                           thetek/webdrive:1.0.0
    restart:                         always
    working_dir:                     /mnt/webdrive/demo
    environment:
      WEBDRIVE_URL:                  https://webdrive/example.com:5001/share/
      WEBDRIVE_UID:                  webdavuid
      WEBDRIVE_PWD:                  webdavpwd
      WEBDRIVE_ROOT_DIR:             /mnt/webdrive/demo
      WPBACKUP_ROOT_DIR:             /var/backups/demo
    volumes:
      - wpbackup-data-volume:/var/backups/demo:cached
      - webdrive-data-volume:/mnt/webdrive/demo:delegated
#    secrets:
#      - source:                      webdrive-cer-key
#        target:                      /etc/davfs2/certs/
#      - source:                      webdrive-dfs-key            
#        target:                      /run/secrets/
#    #configs:
#      - source:                      webdrive-prf-key            
#        target:                      /root/.unison/default.prf
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN
    privileged: true

## Secrets
#secrets:
#  mysql-pwd-key:
#    file:                            
#  dropbox-token-key:
#    file:                            
#  gpg-password-key:
#    file:                            
#  webdrive-cer-key:
#    file:                            
#  webdrive-dfs-key:
#    file:                            
##
## Configs aren't working so sending all config as secrets
## Configs
##configs:
#  mysql-cnf-key:
#    file:                            
#  nginx-wordpress-cnf-key:
#    file:                            
#  nginx-phpmyadmin-cnf-key:
#    file:                            
#  webdrive-prf-key:
#    file:                            


# Volumes
volumes:
  log-data-volume:                   {}
  mysql-data-volume:                 {}
  wordpress-data-volume:             {}
  phpmyadmin-data-volume:            {}
  nginx-cert-volume:                 {}
  wpbackup-data-volume:              {}
  webdrive-data-volume:              {}
  
