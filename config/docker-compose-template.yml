# This file is autogenerated generated from nginx.conf.template
# All chnages should happend in the template and then generate this file via wpcmd -r [-n=<siteName>]
# All environment variables are defined in env.template
version: '3.7'

# Services
services:

  # MySQL Service
  ${MYSQL_SERVICE_NAME}:
    container_name:                ${MYSQL_CONTAINER_NAME}
    image:                         mysql:8.0.22
    restart:                       always
    working_dir:                   /var/lib/mysql
    environment:
      MYSQL_PORT:                  ${MYSQL_PORT}
      MYSQL_DATABASE:              ${MYSQL_DATABASE}
      MYSQL_USER:                  ${MYSQL_USER}
      MYSQL_PASSWORD_FILE:         /run/secrets/${DB_PWD_KEY}
      MYSQL_ALLOW_EMPTY_PASSWORD:  "yes"
    volumes:
      - ./.docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro # to check
      - mysql-volume:/var/lib/mysql
    secrets:
      - ${DB_PWD_KEY}

  # Wordpress Service
  ${WORDPRESS_SERVICE_NAME}:
    container_name:                  ${WORDPRESS_CONTAINER_NAME}
    image:                           wordpress:5.6.0-php7.4-fpm-alpine
    restart:                         always
    working_dir:                     ${WORDPRESS_ROOT_DIR}
    environment:
      WORDPRESS_DB_HOST:             ${MYSQL_SERVICE_NAME}
      WORDPRESS_DB_NAME:             ${MYSQL_DATABASE}
      WORDPRESS_DB_USER:             ${MYSQL_USER}
      WORDPRESS_DB_PASSWORD_FILE:    /run/secrets/${DB_PWD_KEY}
      WORDPRESS_TABLE_PREFIX:        ${WORDPRESS_TABLE_PREFIX}
    volumes:
      - wordpress-volume:${WORDPRESS_ROOT_DIR}
    depends_on:
      - ${MYSQL_SERVICE_NAME}
    links:
      - ${MYSQL_SERVICE_NAME}
    secrets:
      - ${DB_PWD_KEY}

  # PhpMyAdmin Service
  ${PHPMYADMIN_SERVICE_NAME}:
    container_name:                  ${PHPMYADMIN_CONTAINER_NAME}
    image:                           phpmyadmin/phpmyadmin:5.0.0-fpm-alpine 
    restart:                         "no"
    working_dir:                     ${PHPMYADMIN_ROOT_DIR}
    environment:
      PMA_HOST:                      ${MYSQL_SERVICE_NAME}
    volumes:
      - phpmyadmin-volume:${PHPMYADMIN_ROOT_DIR}
    depends_on:
      - ${MYSQL_SERVICE_NAME}

  # Nginx Service
  ${NGINX_SERVICE_NAME}:
    container_name:                  ${NGINX_CONTAINER_NAME}
    image:                           thetek/nginx:1.17-alpine
    restart:                         always
    working_dir:                     /etc/nginx
    environment:
      WORDPRESS_ALL_SERVER_URLS:     ${WORDPRESS_ALL_SERVER_URLS}
      PHPMYADMIN_ALL_SERVER_URLS:    ${PHPMYADMIN_ALL_SERVER_URLS}
      LETSENCRYPT_ADMIN_EMAIL_FILE:  /run/secrets/${ADMIN_EMAIL_KEY}
    volumes:
      - nginx-certboot-volume:/etc/letsencrypt
      - wordpress-volume:${WORDPRESS_ROOT_DIR}:ro,delegated
      - phpmyadmin-volume:${PHPMYADMIN_ROOT_DIR}:ro,delegated
    depends_on:
      - ${WORDPRESS_SERVICE_NAME}
      - ${PHPMYADMIN_SERVICE_NAME}
    secrets:
      - ${ADMIN_EMAIL_KEY}
    ports:
      - ${NGINX_EXT_HTTP_PORT}:80
      - ${NGINX_EXT_HTTPS_PORT}:443

  # Backup service
  ${WPBACKUP_SERVICE_NAME}:
    container_name:                  ${WPBACKUP_CONTAINER_NAME}
    image:                           thetek/wpbackup:1.0.0
    restart:                         always
    working_dir:                     ${WPBACKUP_ROOT_DIR}
    environment:
      WPBACKUP_WEBSITE_NAME:         ${WPBACKUP_WEBSITE_NAME}
      WPBACKUP_MYSQL_HOST:           ${MYSQL_SERVICE_NAME}
      WPBACKUP_MYSQL_PORT:           ${MYSQL_PORT}
      WPBACKUP_MYSQL_DATABASE:       ${MYSQL_DATABASE}
      WPBACKUP_MYSQL_USERNAME:       ${MYSQL_USER}
      WPBACKUP_MYSQL_PASSWORD_FILE:  /run/secrets/${DB_PWD_KEY}
      WPBACKUP_WORDPRESS_DIR:        ${WORDPRESS_ROOT_DIR}
      WPBACKUP_ROOT_DIR:             ${WPBACKUP_ROOT_DIR}
      WPBACKUP_HOUR:                 ${WPBACKUP_HOUR}
    volumes:
      - wordpress-volume:${WORDPRESS_ROOT_DIR}:ro,delegated
      - wpbackup-volume:${WPBACKUP_ROOT_DIR}:cached
    depends_on:
      - ${MYSQL_SERVICE_NAME}
    secrets:
      - ${DB_PWD_KEY}
  
  # Webdrive service
  ${WEBDRIVE_SERVICE_NAME}:
    container_name: ${WEBDRIVE_CONTAINER_NAME}
    image: thetek/webdrive:1.0.0
    restart: always
    working_dir:                     ${WEBDRIVE_ROOT_DIR}
    environment:
      WEBDRIVE_REMOTE_PATH:          ${WEBDRIVE_REMOTE_PATH}
      WEBDRIVE_URL_FILE:             /run/secrets/${WEBDRIVE_URL_KEY}
      WEBDRIVE_UID_FILE:             /run/secrets/${WEBDRIVE_UID_KEY}
      WEBDRIVE_PWD_FILE:             /run/secrets/${WEBDRIVE_PWD_KEY}
    volumes:
      - wpbackup-volume:${WPBACKUP_ROOT_DIR}:cached
      - webdrive-volume:${WEBDRIVE_ROOT_DIR}:delegated
    secrets:
      - ${WEBDRIVE_URL_KEY}
      - ${WEBDRIVE_UID_KEY}
      - ${WEBDRIVE_PWD_KEY}
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN
    privileged: true

# Secrets
secrets:
  ${DB_PWD_KEY}:
    file: ${SRC_MYSQL_PASSWORD_FILE}
  ${ADMIN_EMAIL_KEY}:
    file: ${SRC_LETSENCRYPT_EMAIL_FILE}
  ${WEBDRIVE_URL_KEY}:
    file: ${SRC_WEBDRIVE_URL_FILE}
  ${WEBDRIVE_UID_KEY}:
    file: ${SRC_WEBDRIVE_UID_FILE}
  ${WEBDRIVE_PWD_KEY}:
    file: ${SRC_WEBDRIVE_PWD_FILE}

# Volumes
volumes:
  mysql-volume: {}
  wordpress-volume: {}
  phpmyadmin-volume: {}
  nginx-certboot-volume: {}
  wpbackup-volume: {}
  webdrive-volume: {}